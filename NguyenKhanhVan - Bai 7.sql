-- Nguyen Khanh Van -DHTMDT19A - Bai 7
CREATE DATABASE BANHANG;
GO
USE BANHANG;
GO

CREATE TABLE NHACUNGCAP (
    IDNHACUNGCAP INT PRIMARY KEY,
    TENNHACUNGCAP NVARCHAR(40) NOT NULL
);

CREATE TABLE SANPHAM (
    IDSP INT PRIMARY KEY,
    TENSP NVARCHAR(40) NOT NULL,
    IDNHACUNGCAP INT,
    GIADONVI MONEY DEFAULT 0,
    DONVITRONGKHO SMALLINT DEFAULT 0, 
    FOREIGN KEY (IDNHACUNGCAP) REFERENCES NHACUNGCAP(IDNHACUNGCAP)
);
CREATE TABLE KHACHHANG (
    IDKHACHHANG NCHAR(5) PRIMARY KEY,
    TENCONGTY NVARCHAR(40) NOT NULL,
    DIACHI NVARCHAR(60),
    THANHPHO NVARCHAR(15),
    KHUVUC NVARCHAR(15),
    QUOCGIA NVARCHAR(15)
);
CREATE TABLE NHANVIEN (
    IDNHANVIEN INT PRIMARY KEY,
    HO NVARCHAR(20) NOT NULL,
    TEN NVARCHAR(10) NOT NULL,
    NGAYSINH DATETIME,
    THANHPHO NVARCHAR(15)
);
CREATE TABLE DONHANG (
    IDDONHANG INT PRIMARY KEY,
    IDKHACHHANG NCHAR(5),
    IDNHANVIEN INT,
    NGAYDATHANG DATETIME,
    FOREIGN KEY (IDKHACHHANG) REFERENCES KHACHHANG(IDKHACHHANG),
    FOREIGN KEY (IDNHANVIEN) REFERENCES NHANVIEN(IDNHANVIEN)  
);
CREATE TABLE CT_DONHANG (
    IDDONHANG INT,
    IDSP INT,
    DONGIA MONEY NOT NULL DEFAULT 0,
    SOLUONG SMALLINT NOT NULL DEFAULT 1,
    GIAMGIA REAL NOT NULL DEFAULT 0,
    PRIMARY KEY (IDDONHANG, IDSP), 
    FOREIGN KEY (IDDONHANG) REFERENCES DONHANG(IDDONHANG),
    FOREIGN KEY (IDSP) REFERENCES SANPHAM(IDSP)
);



      


INSERT INTO NHACUNGCAP (IDNHACUNGCAP, TENNHACUNGCAP)
VALUES (1, 'Nhà Cung Cấp A'),
       (2, 'Nhà Cung Cấp B'),
       (3, 'Nhà Cung Cấp C');
INSERT INTO SANPHAM (IDSP, TENSP, IDNHACUNGCAP, GIADONVI, DONVITRONGKHO)
VALUES (101, 'Sản phẩm A', 1, 100000, 50),
       (102, 'Sản phẩm B', 2, 200000, 30),
       (103, 'Sản phẩm C', 3, 150000, 20);
INSERT INTO KHACHHANG (IDKHACHHANG, TENCONGTY, DIACHI, THANHPHO, KHUVUC, QUOCGIA)
VALUES ('KH001', 'Công Ty A', 'Địa chỉ A', 'Hà Nội', 'Miền Bắc', 'Việt Nam'),
       ('KH002', 'Công Ty B', 'Địa chỉ B', 'TP.HCM', 'Miền Nam', 'Việt Nam'),
       ('KH003', 'Công Ty C', 'Địa chỉ C', 'Đà Nẵng', 'Miền Trung', 'Việt Nam');
INSERT INTO NHANVIEN (IDNHANVIEN, HO, TEN, NGAYSINH, THANHPHO)
VALUES (1, 'Nguyễn', 'A', '1985-10-10', 'Hà Nội'),
       (2, 'Trần', 'B', '1990-05-15', 'TP.HCM'),
       (3, 'Lê', 'C', '1988-08-20', 'Đà Nẵng');
INSERT INTO DONHANG (IDDONHANG, IDKHACHHANG, IDNHANVIEN, NGAYDATHANG)
VALUES (1001, 'KH001', 1, '2025-03-01'),
       (1002, 'KH002', 2, '2025-03-02'),
       (1003, 'KH003', 3, '2025-03-03');
INSERT INTO CT_DONHANG (IDDONHANG, IDSP, DONGIA, SOLUONG, GIAMGIA)
VALUES (1001, 101, 100000, 2, 0.1),
       (1002, 102, 200000, 3, 0.15),
       (1003, 103, 150000, 1, 0.2);
-- câu 1
SELECT 
    d.IDDONHANG AS OrdersId, 
    d.NGAYDATHANG AS OrderDate,
    SUM(ct.SOLUONG * ct.DONGIA - ct.GIAMGIA) AS TotalAccount
FROM 
    DONHANG d
JOIN 
    CT_DONHANG ct ON d.IDDONHANG = ct.IDDONHANG
GROUP BY 
    d.IDDONHANG, d.NGAYDATHANG;
-- câu 2
SELECT 
    d.IDDONHANG AS OrdersId, 
    d.NGAYDATHANG AS OrderDate,
    SUM(ct.SOLUONG * ct.DONGIA - ct.GIAMGIA) AS TotalAccount
FROM 
    DONHANG d
JOIN 
    KHACHHANG k ON d.IDKHACHHANG = k.IDKHACHHANG
JOIN 
    CT_DONHANG ct ON d.IDDONHANG = ct.IDDONHANG
WHERE 
    k.THANHPHO = 'Madrid'  
GROUP BY 
    d.IDDONHANG, d.NGAYDATHANG;
--câu3
SELECT 
    p.IDSP AS ProductID,
    p.TENSP AS ProductName,
    SUM(ct.SOLUONG) AS CountOfOrders
FROM 
    CT_DONHANG ct
JOIN 
    SANPHAM p ON ct.IDSP = p.IDSP
GROUP BY 
    p.IDSP, p.TENSP
ORDER BY 
    CountOfOrders DESC
--câu 4
SELECT 
    k.IDKHACHHANG AS CustomerID,
    k.TENCONGTY AS CompanyName,
    COUNT(d.IDDONHANG) AS CountOfOrder
FROM 
    KHACHHANG k
JOIN 
    DONHANG d ON k.IDKHACHHANG = d.IDKHACHHANG
GROUP BY 
    k.IDKHACHHANG, k.TENCONGTY;
-- câu 5
SELECT 
    e.IDNHANVIEN AS EmployeeID,
    e.HO + ' ' + e.TEN AS EmployeeName,
    COUNT(d.IDDONHANG) AS CountOfOrders,
    SUM(ct.SOLUONG * ct.DONGIA - ct.GIAMGIA) AS TotalAmount
FROM 
    NHANVIEN e
JOIN 
    DONHANG d ON e.IDNHANVIEN = d.IDNHANVIEN
JOIN 
    CT_DONHANG ct ON d.IDDONHANG = ct.IDDONHANG
GROUP BY 
    e.IDNHANVIEN, e.HO, e.TEN;
-- câu 6
SELECT 
    e.IDNHANVIEN AS EmployeeID,
    e.HO + ' ' + e.TEN AS EmployeeName,
    MONTH(d.NGAYDATHANG) AS Month_Salary,
    SUM(ct.SOLUONG * ct.DONGIA - ct.GIAMGIA) * 0.1 AS Salary  -- Tính lương nhân với 10%
FROM 
    NHANVIEN e
JOIN 
    DONHANG d ON e.IDNHANVIEN = d.IDNHANVIEN
JOIN 
    CT_DONHANG ct ON d.IDDONHANG = ct.IDDONHANG
WHERE 
    YEAR(d.NGAYDATHANG) = 1996  -- Chỉ tính lương trong năm 1996
GROUP BY 
    e.IDNHANVIEN, e.HO, e.TEN, MONTH(d.NGAYDATHANG)
ORDER BY 
    Month_Salary, Salary DESC;
SELECT * FROM DONHANG WHERE YEAR(NGAYDATHANG) = 1996;
--câu 7
SELECT 
    k.IDKHACHHANG AS CustomerID,
    k.TENCONGTY AS CompanyName,
    SUM(ct.SOLUONG * ct.DONGIA - ct.GIAMGIA) AS TotalAccount
FROM 
    KHACHHANG k
JOIN 
    DONHANG d ON k.IDKHACHHANG = d.IDKHACHHANG
JOIN 
    CT_DONHANG ct ON d.IDDONHANG = ct.IDDONHANG
WHERE 
    d.NGAYDATHANG BETWEEN '1996-12-31' AND '1998-01-01'
GROUP BY 
    k.IDKHACHHANG, k.TENCONGTY
HAVING 
    SUM(ct.SOLUONG * ct.DONGIA - ct.GIAMGIA) > 10000;
-- câu 8
SELECT 
    k.IDKHACHHANG AS CustomerID,
    k.TENCONGTY AS CompanyName,
    COUNT(d.IDDONHANG) AS CountOfOrders,
    SUM(ct.SOLUONG * ct.DONGIA - ct.GIAMGIA) AS TotalAmount
FROM 
    KHACHHANG k
JOIN 
    DONHANG d ON k.IDKHACHHANG = d.IDKHACHHANG
JOIN 
    CT_DONHANG ct ON d.IDDONHANG = ct.IDDONHANG
WHERE 
    d.NGAYDATHANG BETWEEN '1996-12-31' AND '1998-01-01'
GROUP BY 
    k.IDKHACHHANG, k.TENCONGTY
HAVING 
    SUM(ct.SOLUONG * ct.DONGIA - ct.GIAMGIA) > 10000
ORDER BY 
    CustomerID, TotalAmount DESC;
-- câu 9

	SELECT 
    n.IDNHACUNGCAP, 
    n.TENNHACUNGCAP, 
    SUM(s.DONVITRONGKHO) AS Total_UnitsInStock, 
    AVG(s.GIADONVI) AS Average_Unitprice
FROM 
    SANPHAM s
JOIN 
    NHACUNGCAP n ON s.IDNHACUNGCAP = n.IDNHACUNGCAP  
GROUP BY 
    n.IDNHACUNGCAP, n.TENNHACUNGCAP
HAVING 
    SUM(s.DONVITRONGKHO) > 300  
    AND AVG(s.GIADONVI) < 25;  

--Câu 10
CREATE TABLE LOAISANPHAM (
    IDLOAI INT PRIMARY KEY,
    TENLOAI NVARCHAR(40) NOT NULL
);
ALTER TABLE SANPHAM
ADD IDLOAI INT;
UPDATE SANPHAM SET IDLOAI = 1 WHERE TENSP LIKE N'%Tivi%' OR TENSP LIKE N'%Laptop%';
UPDATE SANPHAM SET IDLOAI = 2 WHERE TENSP LIKE N'%Máy giặt%' OR TENSP LIKE N'%Bếp từ%';
UPDATE SANPHAM SET IDLOAI = 3 WHERE TENSP LIKE N'%Bánh%' OR TENSP LIKE N'%Sữa%';
UPDATE SANPHAM SET IDLOAI = 4 WHERE TENSP LIKE N'%Áo%' OR TENSP LIKE N'%Quần%';
UPDATE SANPHAM SET IDLOAI = 5 WHERE TENSP LIKE N'%Bút%' OR TENSP LIKE N'%Giấy%';
ALTER TABLE SANPHAM
ADD CONSTRAINT FK_SANPHAM_LOAISANPHAM FOREIGN KEY (IDLOAI) REFERENCES LOAISANPHAM(IDLOAI);

INSERT INTO LOAISANPHAM (IDLOAI, TENLOAI)
VALUES 
    (1, 'Điện tử'),
    (2, 'Gia dụng'),
    (3, 'Thực phẩm'),
    (4, 'Thời trang'),
    (5, 'Văn phòng phẩm');
SELECT 
    LSP.IDLOAI AS MaLoaiSanPham, 
    LSP.TENLOAI AS TenLoaiSanPham, 
    COUNT(SP.IDSP) AS TongSoSanPham
FROM LOAISANPHAM LSP
LEFT JOIN SANPHAM SP ON LSP.IDLOAI = SP.IDLOAI
GROUP BY LSP.IDLOAI, LSP.TENLOAI
HAVING COUNT(SP.IDSP) < 10
ORDER BY LSP.TENLOAI ASC, TongSoSanPham DESC;

-- câu 11

SELECT 
    p.IDSP,
    p.TENSP,
    SUM(ct.SOLUONG) 
FROM 
    SANPHAM p  
JOIN 
    CT_DONHANG ct ON p.IDSP = ct.IDSP  
JOIN 
    DONHANG d ON ct.IDDONHANG = d.IDDONHANG  
WHERE 
    d.NGAYDATHANG BETWEEN '1998-01-01' AND '1998-03-31'  
GROUP BY 
    p.IDSP, p.TENSP 
HAVING 
    SUM(ct.SOLUONG) > 200; 
-- câu 12
SELECT 
    k.IDKHACHHANG, 
    k.TENCONGTY, 
    CONCAT(MONTH(d.NGAYDATHANG), '-', YEAR(d.NGAYDATHANG)) AS Month_Year,
    SUM(ct.SOLUONG * ct.DONGIA - ct.GIAMGIA) AS Total  
FROM 
    KHACHHANG k
JOIN 
    DONHANG d ON k.IDKHACHHANG = d.IDKHACHHANG
JOIN 
    CT_DONHANG ct ON d.IDDONHANG = ct.IDDONHANG
GROUP BY 
    k.IDKHACHHANG, k.TENCONGTY, MONTH(d.NGAYDATHANG), YEAR(d.NGAYDATHANG)  
ORDER BY 
    k.IDKHACHHANG, Month_Year;  
-- câu 13
SELECT TOP 1
    e.IDNHANVIEN,
    e.HO + ' ' + e.TEN
FROM 
    NHANVIEN e
JOIN 
    DONHANG d ON e.IDNHANVIEN = d.IDNHANVIEN
JOIN 
    CT_DONHANG ct ON d.IDDONHANG = ct.IDDONHANG
WHERE 
    d.NGAYDATHANG BETWEEN '1997-07-01' AND '1997-07-31'  
GROUP BY 
    e.IDNHANVIEN, e.HO, e.TEN  
ORDER BY 
    SUM(ct.SOLUONG * ct.DONGIA) DESC; 
--14
SELECT TOP 3
    k.IDKHACHHANG,
    k.TENCONGTY,
    COUNT(d.IDDONHANG) 
FROM 
    KHACHHANG k
JOIN 
    DONHANG d ON k.IDKHACHHANG = d.IDKHACHHANG
WHERE 
    d.NGAYDATHANG BETWEEN '1996-01-01' AND '1996-12-31'  
GROUP BY 
    k.IDKHACHHANG, k.TENCONGTY 
ORDER BY 
    COUNT(d.IDDONHANG) DESC;  
-- câu 15
SELECT 
    e.IDNHANVIEN,
    e.HO + ' ' + e.TEN 
FROM 
    NHANVIEN e
JOIN 
    DONHANG d ON e.IDNHANVIEN = d.IDNHANVIEN
JOIN 
    CT_DONHANG ct ON d.IDDONHANG = ct.IDDONHANG
WHERE 
    d.NGAYDATHANG BETWEEN '1997-03-01' AND '1997-03-31' 
GROUP BY 
    e.IDNHANVIEN, e.HO, e.TEN  
HAVING 
    SUM(ct.SOLUONG * ct.DONGIA) > 4000  
ORDER BY 
    e.IDNHANVIEN DESC;  